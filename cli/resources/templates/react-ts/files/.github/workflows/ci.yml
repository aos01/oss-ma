name: codeql

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: "0 3 * * 1" # every Monday 03:00 UTC

permissions: {}

jobs:
  analyze:
    name: Analyze (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript-typescript"]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Initialize CodeQL
        uses: github/codeql-action/init@f5c2471be782132e47a6e6f9c725e56730d6e9a3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@f5c2471be782132e47a6e6f9c725e56730d6e9a3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@f5c2471be782132e47a6e6f9c725e56730d6e9a3


# name: ci

# on:
#   push:
#     branches: ["main"]
#   pull_request:

# concurrency:
#   group: ci-${{ github.ref }}
#   cancel-in-progress: true

# # Global: deny everything, grant per-job only
# permissions: {}

# jobs:
#   # ── 1. Secrets Scan ───────────────────────────────────────────────────────
#   secrets-scan:
#     name: Secrets Scan
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           fetch-depth: 0
#           persist-credentials: false

#       - name: Run Gitleaks
#         uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c3 # v2.3.9
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#   # ── 2. Dependency Audit (blocking) ────────────────────────────────────────
#   audit:
#     name: Dependency Audit
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           persist-credentials: false

#       - name: Setup Node.js
#         uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.1.0
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install
#         run: npm ci --ignore-scripts

#       - name: Audit (high+) — blocking
#         run: npm audit --audit-level=high

#   # ── 3. Lint ───────────────────────────────────────────────────────────────
#   lint:
#     name: Lint
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           persist-credentials: false

#       - name: Setup Node.js
#         uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.1.0
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install
#         run: npm ci --ignore-scripts

#       - name: Lint
#         run: npm run lint

#   # ── 4. Typecheck ──────────────────────────────────────────────────────────
#   typecheck:
#     name: Typecheck
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           persist-credentials: false

#       - name: Setup Node.js
#         uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.1.0
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install
#         run: npm ci --ignore-scripts

#       - name: Typecheck
#         run: npm run typecheck

#   # ── 5. Test ───────────────────────────────────────────────────────────────
#   test:
#     name: Test
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           persist-credentials: false

#       - name: Setup Node.js
#         uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.1.0
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install
#         run: npm ci --ignore-scripts

#       - name: Test
#         run: npm run test

#   # ── 6. Build (gate — requires all checks to pass) ─────────────────────────
#   build:
#     name: Build
#     runs-on: ubuntu-latest
#     needs: [secrets-scan, audit, lint, typecheck, test]
#     permissions:
#       contents: read

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
#         with:
#           persist-credentials: false

#       - name: Setup Node.js
#         uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.1.0
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install
#         run: npm ci --ignore-scripts

#       - name: Build
#         run: npm run build

# # name: ci

# # on:
# #   push:
# #     branches: ["main"]
# #   pull_request:

# # concurrency:
# #   group: ci-${{ github.ref }}
# #   cancel-in-progress: true

# # jobs:
# #   lint:
# #     runs-on: ubuntu-latest
# #     steps:
# #       - uses: actions/checkout@v4

# #       - uses: actions/setup-node@v4
# #         with:
# #           node-version: "20"
# #           cache: "npm"

# #       - name: Install
# #         run: npm ci

# #       - name: Lint
# #         run: npm run lint

# #   typecheck:
# #     runs-on: ubuntu-latest
# #     steps:
# #       - uses: actions/checkout@v4

# #       - uses: actions/setup-node@v4
# #         with:
# #           node-version: "20"
# #           cache: "npm"

# #       - name: Install
# #         run: npm ci

# #       - name: Typecheck
# #         run: npm run typecheck

# #   test:
# #     runs-on: ubuntu-latest
# #     steps:
# #       - uses: actions/checkout@v4

# #       - uses: actions/setup-node@v4
# #         with:
# #           node-version: "20"
# #           cache: "npm"

# #       - name: Install
# #         run: npm ci

# #       - name: Test
# #         run: npm run test

# #   build:
# #     runs-on: ubuntu-latest
# #     needs: [lint, typecheck, test]
# #     steps:
# #       - uses: actions/checkout@v4

# #       - uses: actions/setup-node@v4
# #         with:
# #           node-version: "20"
# #           cache: "npm"

# #       - name: Install
# #         run: npm ci

# #       - name: Build
# #         run: npm run build

# #   audit:
# #     runs-on: ubuntu-latest
# #     needs: [lint, typecheck, test]
# #     continue-on-error: true
# #     steps:
# #       - uses: actions/checkout@v4

# #       - uses: actions/setup-node@v4
# #         with:
# #           node-version: "20"
# #           cache: "npm"

# #       - name: Install
# #         run: npm ci

# #       - name: Audit (high+)
# #         run: npm run audit
